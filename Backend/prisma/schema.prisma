generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User & Authentication
// ============================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  firstName String
  lastName  String
  phone     String?
  address   String?
  city      String?
  country   String?
  image     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  memberships              TeamMember[]
  organizationMemberships  OrganizationMember[]
  checkIns                 CheckIn[]
  excuseRequests           ExcuseRequest[]
  guardianOf               GuardianLink[] @relation("GuardianOf")
  guardedBy                GuardianLink[] @relation("GuardedBy")
  deviceTokens             DeviceToken[]
  notificationPreferences  NotificationPreferences?
  emailReportConfigs       EmailReportConfig[]
  notificationDeliveries   NotificationDelivery[]
  createdAnnouncements     Announcement[]
}

// ============================================
// Organization & Teams
// ============================================

model Organization {
  id        String   @id @default(cuid())
  name      String
  image     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  teams              Team[]
  events             Event[]
  members            OrganizationMember[]
  recurringEvents    RecurringEvent[]
  invites            Invite[]
  nfcTags            NfcTag[]
  guardianLinks      GuardianLink[]
  seasons            OrgSeason[]
  announcements      Announcement[]
  emailReportConfigs EmailReportConfig[]
}

model OrgSeason {
  id             String       @id @default(cuid())
  name           String       // e.g., "Hockey Season", "Summer Training"
  startMonth     Int          // 1-12
  endMonth       Int          // 1-12
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  teams          Team[]

  @@unique([organizationId, name])
  @@index([organizationId])
}

model Team {
  id             String    @id @default(cuid())
  name           String
  season         String?
  sport          String?
  color          String?
  description    String?
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  orgSeasonId    String?
  orgSeason      OrgSeason?   @relation(fields: [orgSeasonId], references: [id])
  seasonYear     Int?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  archivedAt     DateTime?

  // Relations
  members             TeamMember[]
  events              Event[]
  recurringEvents     RecurringEvent[]
  participatingEvents Event[]          @relation("EventParticipatingTeams")

  @@index([organizationId])
}

model TeamMember {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  teamId        String
  team          Team     @relation(fields: [teamId], references: [id])
  role          TeamRole @default(MEMBER)
  hoursRequired Float    @default(0) // Required hours per period
  joinedAt      DateTime @default(now())

  @@unique([userId, teamId])
  @@index([teamId])
  @@index([userId])
}

enum TeamRole {
  MEMBER
  CAPTAIN
  COACH
  ADMIN
}

enum OrgRole {
  OWNER
  ADMIN
  MANAGER
  COACH
  ATHLETE
  GUARDIAN
}

model OrganizationMember {
  id             String       @id @default(cuid())
  userId         String
  user           User         @relation(fields: [userId], references: [id])
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  role           OrgRole      @default(ATHLETE)
  joinedAt       DateTime     @default(now())

  @@unique([userId, organizationId])
  @@index([organizationId])
  @@index([userId])
}

// ============================================
// Events & Calendar
// ============================================

model Event {
  id             String       @id @default(cuid())
  title          String
  type           EventType
  date           DateTime
  endDate        DateTime?
  startTime      String // e.g., "6:00 PM"
  endTime        String // e.g., "8:00 PM"
  location       String?
  description    String?
  isAdHoc        Boolean      @default(false)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  teamId         String?
  team           Team?        @relation(fields: [teamId], references: [id])
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  checkIns           CheckIn[]
  excuseRequests     ExcuseRequest[]
  recurringEventId   String?
  recurringEvent     RecurringEvent? @relation(fields: [recurringEventId], references: [id])
  participatingTeams Team[]          @relation("EventParticipatingTeams")

  @@index([organizationId])
  @@index([teamId])
  @@index([date])
}

enum EventType {
  PRACTICE
  EVENT
  MEETING
  REST
}

// ============================================
// Attendance & Check-ins
// ============================================

model CheckIn {
  id           String           @id @default(cuid())
  userId       String
  user         User             @relation(fields: [userId], references: [id])
  eventId      String
  event        Event            @relation(fields: [eventId], references: [id])
  status       AttendanceStatus
  checkInTime  DateTime?
  checkOutTime DateTime?
  hoursLogged  Float?
  note         String?
  isAdHoc      Boolean          @default(false)
  approved     Boolean          @default(true)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  @@unique([userId, eventId])
  @@index([userId])
  @@index([eventId])
}

enum AttendanceStatus {
  ON_TIME
  LATE
  ABSENT
  EXCUSED
}

model ExcuseRequest {
  id        String              @id @default(cuid())
  userId    String
  user      User                @relation(fields: [userId], references: [id])
  eventId   String
  event     Event               @relation(fields: [eventId], references: [id])
  reason    String
  status    ExcuseRequestStatus @default(PENDING)
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt

  @@unique([userId, eventId])
  @@index([userId])
  @@index([eventId])
}

enum ExcuseRequestStatus {
  PENDING
  APPROVED
  DENIED
}

// ============================================
// Invites
// ============================================

enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
}

model Invite {
  id             String       @id @default(cuid())
  email          String
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  role           OrgRole      @default(ATHLETE)
  teamIds        String[]
  athleteId      String?
  token          String       @unique @default(cuid())
  status         InviteStatus @default(PENDING)
  createdAt      DateTime     @default(now())
  expiresAt      DateTime

  @@unique([email, organizationId])
  @@index([token])
  @@index([organizationId])
}

// ============================================
// NFC Tags
// ============================================

model NfcTag {
  id             String       @id @default(cuid())
  token          String       @unique
  name           String
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  isActive       Boolean      @default(true)
  createdBy      String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
  @@index([token])
}

// ============================================
// Recurring Events
// ============================================

enum RecurrenceFrequency {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
}

model RecurringEvent {
  id             String              @id @default(cuid())
  title          String
  type           EventType
  startTime      String
  endTime        String
  location       String?
  description    String?
  frequency      RecurrenceFrequency
  daysOfWeek     Int[]               // 0=Sun..6=Sat, used for WEEKLY/BIWEEKLY
  startDate      DateTime
  endDate        DateTime
  organizationId String
  organization   Organization        @relation(fields: [organizationId], references: [id])
  teamId         String?
  team           Team?               @relation(fields: [teamId], references: [id])
  events         Event[]
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  @@index([organizationId])
}

// ============================================
// Guardian Links
// ============================================

model GuardianLink {
  id             String       @id @default(cuid())
  guardianId     String
  guardian       User         @relation("GuardianOf", fields: [guardianId], references: [id])
  athleteId      String
  athlete        User         @relation("GuardedBy", fields: [athleteId], references: [id])
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  createdAt      DateTime     @default(now())

  @@unique([guardianId, athleteId, organizationId])
  @@index([guardianId])
  @@index([athleteId])
}

// ============================================
// Notifications & Announcements
// ============================================

enum Platform {
  IOS
  ANDROID
  WEB
}

enum AnnouncementTarget {
  ALL_TEAMS
  SPECIFIC_TEAMS
  SPECIFIC_USERS
  CUSTOM
  EVENT_DAY
}

enum ReportFrequency {
  WEEKLY
  MONTHLY
  QUARTERLY
  BIANNUALLY
}

enum NotificationType {
  EVENT_REMINDER
  ANNOUNCEMENT
  EXCUSE_STATUS
  ATTENDANCE_MILESTONE
  EMAIL_REPORT
}

enum NotificationChannel {
  EMAIL
  PUSH
  SMS
}

enum DeliveryStatus {
  PENDING
  SENT
  FAILED
  SKIPPED
}

// Device tokens for push notifications
model DeviceToken {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   // Expo push token
  platform  Platform
  endpoint  String?  // SNS platform endpoint ARN
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, token])
  @@index([userId])
  @@index([isActive])
}

// User notification preferences
model NotificationPreferences {
  id                    String   @id @default(cuid())
  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  emailEnabled          Boolean  @default(false)
  pushEnabled           Boolean  @default(true)
  smsEnabled            Boolean  @default(false)
  eventRemindersEnabled Boolean  @default(true)
  eventReminderMinutes  Int      @default(120) // 2 hours default
  announcementsEnabled  Boolean  @default(true)
  excuseStatusEnabled   Boolean  @default(true)
  milestonesEnabled     Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([userId])
}

// Announcements
model Announcement {
  id             String             @id @default(cuid())
  title          String
  message        String             @db.Text
  organizationId String
  organization   Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy      String
  creator        User               @relation(fields: [createdBy], references: [id])
  targetType     AnnouncementTarget @default(ALL_TEAMS)
  teamIds        String[]
  userIds        String[]
  eventDate      DateTime?
  scheduledFor   DateTime?
  sentAt         DateTime?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  deliveries     NotificationDelivery[]

  @@index([organizationId])
  @@index([createdBy])
  @@index([sentAt])
}

// Email report configuration for guardians
model EmailReportConfig {
  id             String          @id @default(cuid())
  userId         String
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  organizationId String
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  frequency      ReportFrequency
  enabled        Boolean         @default(true)
  lastSentAt     DateTime?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
  @@index([enabled, frequency])
}

// Notification delivery history
model NotificationDelivery {
  id             String              @id @default(cuid())
  userId         String
  user           User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  type           NotificationType
  channel        NotificationChannel
  title          String
  message        String              @db.Text
  metadata       Json?
  status         DeliveryStatus      @default(PENDING)
  errorMessage   String?
  announcementId String?
  announcement   Announcement?       @relation(fields: [announcementId], references: [id])
  sentAt         DateTime?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}
